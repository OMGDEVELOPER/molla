<script>
  {% for block in section.blocks %}
    {% if block.type == 'parent_menu' %}
      window.menuData["{{ block.id }}"] = window.menuData["{{ block.id }}"] || {};
      window.menuData["{{ block.id }}"]["{{ block.settings.submenu }}"] = {
        id: "{{ block.settings. block.settings.parent_menu_id | escape }}",
        title: "{{ block.settings.parent_menu_label | escape }}",
        items: [
          {% assign main_menu = linklists[block.settings.submenu] %}
          {% for top_link in main_menu.links %}
            {
              title: "{{ top_link.title | escape }}",
              url: "{{ top_link.url }}",
              children: [
                {% for child_link in top_link.links %}
                  {
                    title: "{{ child_link.title | escape }}",
                    url: "{{ child_link.url }}",
                    children: [
                      {% for subchild_link in child_link.links %}
                        {
                          title: "{{ subchild_link.title | escape }}",
                          url: "{{ subchild_link.url }}"
                        }{% unless forloop.last %},{% endunless %}
                      {% endfor %}
                    ]
                  }{% unless forloop.last %},{% endunless %}
                {% endfor %}
              ]
            }{% unless forloop.last %},{% endunless %}
          {% endfor %}
        ]
      };
    {% endif %}
  {% endfor %}
</script>

{% javascript %}
document.addEventListener('DOMContentLoaded', () => {
  const allMenus = window.menuData;
  console.log(allMenus)

  Object.entries(allMenus).forEach(([blockId, menus]) => {
    function renderSubmenu(menu) {
      let html = `
      <div class="col-12 col-md-3 item item__2 w-300px level-2 lvl-2" menu-name="${menu.title}-${blockId}" submenu-order="2" parent-id="${menu.id}">
        <div class="item__1__group">
          <div class="submenu__heading heading__1">
            <h3 class="uppercase">${menu.title}</h3>
          </div>
          <ul class="submenu__items level-2 submenu-inner">
      `;

      menu.items.forEach((top) => {
        let hasChildren = Array.isArray(top.children) && top.children.length;
        html += `
        <li class="${hasChildren ? 'submenu-with-children' : ''}" submenu-order="2">
          <a href="${top.url}">${top.title}</a>
        `;

        if (hasChildren) {
          html += `
          <div class="submenu-items-container style-2 w-300px lvl-3" submenu-order="3">
            <div class="submenu__heading"><h3>${top.title}</h3></div>
            <ul class="submenu__items item">
          `;

          top.children.forEach((child) => {
            let hasSubChildren = Array.isArray(child.children) && child.children.length;
            html += `<li submenu-order="3" class="has-third-level ${hasSubChildren ? 'submenu-with-children' : ''}">
              <a href="${child.url}">${child.title}</a>
            `;

            if (hasSubChildren) {
              html += `
              <ul class="style-2 w-300px submenu-items-container lvl-4" submenu-order="4">
                <div class="submenu__heading"><h3>${child.title}</h3></div>
              `;
              child.children.forEach((sub) => {
                html += `<li submenu-order="4" class="menu-item-last-child"><a href="${sub.url}">${sub.title}</a></li>`;
              });
              html += `</ul>`;
            }

            html += `</li>`;
          });

          html += `</ul></div>`;
        }

        html += `</li>`;
      });

      html += `</ul></div></div>`;
      return html;
    }

    let renderedHTML = '';
    Object.values(menus).forEach((menu) => {
      renderedHTML += renderSubmenu(menu);
    });

    const container = document.getElementById(`extra-columns-display-container`);
    if (container) container.innerHTML = renderedHTML;

    // Optional debug:
    console.log(`Rendered submenu for blockId: ${blockId}`);
  });
});
{% endjavascript %}
